#!/bin/bash
#SBATCH --job-name=HighwayPPO
#SBATCH --partition={{ partition }}
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --array=0-{{ n_experiments - 1 }}
#SBATCH --cpus-per-task={{ cpus_per_task }}
#SBATCH --mem-per-gpu={{ mem_per_gpu }}
#SBATCH --gres=gpu:{{ gpus }}
#SBATCH --time={{ time }}
#SBATCH --output={{ log_dir }}/%A_%a.out
#SBATCH --error={{ log_dir }}/%A_%a.err

module purge
module load cuda/12.4
module load cudnn/9.0.0-cuda12
cd "$SLURM_SUBMIT_DIR"
uv venv --seed
uv sync
# Roundâ€‘robin GPU selection (oversubscribe OK)
TASK_ID=${SLURM_ARRAY_TASK_ID}
NUM_GPUS=$(nvidia-smi -L | wc -l)
if [ "$NUM_GPUS" -gt 0 ]; then
    export CUDA_VISIBLE_DEVICES=$(( TASK_ID % NUM_GPUS ))
fi
srun uv run {{ python_script }} --exp-index $TASK_ID
