#!/bin/bash
#SBATCH --job-name=HighwayPPO
#SBATCH --partition=GPU
#SBATCH --nodes=1
#SBATCH --ntasks={{ n_experiments }}
#SBATCH --cpus-per-task={{ cpus_per_task }}
#SBATCH --mem-per-gpu=1G
#SBATCH --gres=gpu:{{ gpus }}
#SBATCH --time={{ time }}
#SBATCH --output={{ log_dir }}/%A_%a.out
#SBATCH --error={{ log_dir }}/%A_%a.err

module purge
module load cuda/12.4
module load cudnn/9.0.0-cuda12
cd "$SLURM_SUBMIT_DIR"
uv venv --seed
uv sync
# Roundâ€‘robin GPU selection (oversubscribe OK)
TASK_ID=${SLURM_PROCID}
NUM_GPUS=$(nvidia-smi -L | wc -l)
if [ "$NUM_GPUS" -gt 0 ]; then
    export CUDA_VISIBLE_DEVICES=$(( TASK_ID % NUM_GPUS ))
fi
srun uv run main.py --exp-index $TASK_ID
